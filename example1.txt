#BILLING_ID=$(./gcp-bill-viewer.py --list-accounts --format csv | tail -n +3 | cut -d"," -f1)
#BILLING_ID=$(./gcp-bill-viewer.py --list-accounts --format json | tail -n +3 | jq -r ".[0].id")
BILLING_ID=$(gcloud billing accounts list --format="value(ACCOUNT_ID)" --limit=1)
PROJECT_ID=songbp

gcloud auth application-default login

gcloud services enable bigquery.googleapis.com --project=$PROJECT_ID

# Assign the roles/bigquery.admin IAM role
./grant-bq-access.sh setup user@your.org
# This user should have roles/billing.costsManager rights (cost exports, budgets, and alerts), so you may need to use admin, in more restrictive environments
./grant-bq-access.sh setup admin@your.org

./setup_bigquery_export.py --billing-account $BILLING_ID --project $PROJECT_ID --setup

# Login via your browser to the user whom you've assigned the roles/bigquery.admin role to, so either user@your.org or admin@your.org

# Run this 60 minutes later
./check_bigquery.py

# Last 30 days (default)
./gcp-bill-viewer.py --costs --billing-account $BILLING_ID
